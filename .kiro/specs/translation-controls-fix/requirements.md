# 需求文档

## 简介

本文档定义了修复翻译功能控制开关无效问题的需求。当前新的模块化翻译系统 (`src/presentation/translation/content-script/`) 缺少配置更新方法 (`updateConfig`)，导致用户在设置面板中更改翻译配置后，配置无法应用到 WhatsApp Web 页面中的翻译脚本。

本文档覆盖翻译系统的所有功能，包括：
- 消息自动翻译
- 输入框翻译
- 中文拦截
- 实时翻译预览
- 反向翻译验证
- 好友独立配置
- 翻译引擎和语言设置
- 配置同步机制

## 术语表

- **WhatsAppTranslation**: 注入到 WhatsApp Web 页面中的翻译系统对象，负责消息翻译、输入框翻译等功能
- **ContentScriptCore**: 翻译系统的核心模块，管理配置和初始化
- **MessageTranslator**: 消息翻译模块，负责翻译接收到的消息
- **InputBoxTranslator**: 输入框翻译模块，负责翻译发送前的消息
- **DOMObserver**: DOM 观察模块，负责监听消息变化和聊天切换
- **TranslationUI**: UI 模块，负责显示翻译结果、提示和预览
- **BrowserView**: Electron 中用于显示 WhatsApp Web 的视图组件
- **IPC**: Electron 中主进程和渲染进程之间的通信机制
- **翻译设置面板**: 主窗口中用于配置翻译功能的 UI 面板 (`translateSettingsPanel.js`)
- **配置变更通知**: 当配置保存后，通知 BrowserView 更新配置的机制
- **实时翻译预览**: 在输入框输入时实时显示翻译结果的功能
- **反向翻译验证**: 将翻译结果再翻译回原语言以验证翻译准确性的功能
- **好友独立配置**: 为不同联系人设置独立翻译配置的功能

## 需求列表

### 需求 1：消息翻译控制

**用户故事:** 作为用户，我希望能够通过设置面板开关消息翻译功能，以便控制何时启用自动翻译。

#### 验收标准

1. 当用户将"自动翻译消息"开关切换为开启时，翻译系统应立即自动翻译当前聊天中的所有收到的消息
2. 当用户将"自动翻译消息"开关切换为关闭时，翻译系统应停止翻译收到的消息
3. 当用户将"群组消息翻译"开关切换为开启时，翻译系统应翻译群聊中的消息
4. 当用户将"群组消息翻译"开关切换为关闭时，翻译系统应跳过群聊消息的翻译

### 需求 2：输入框翻译功能

**用户故事:** 作为用户，我希望使用输入框翻译功能，以便在发送消息前翻译我的消息。

#### 验收标准

1. 当用户将"启用输入框翻译按钮"开关切换为开启时，翻译系统应在输入框附近显示一个浮动翻译按钮
2. 当用户将"启用输入框翻译按钮"开关切换为关闭时，翻译系统应移除浮动翻译按钮
3. 当用户点击翻译按钮时，翻译系统应将输入框内容翻译为配置的目标语言
4. 当用户更改"输入框翻译引擎"选择时，翻译系统应使用所选引擎进行输入框翻译
5. 当用户更改"输入框翻译目标语言"选择时，翻译系统应将输入框内容翻译为所选语言
6. 当用户更改"翻译风格"选择时，翻译系统应将所选风格应用于 AI 驱动的输入框翻译

### 需求 3：中文拦截功能

**用户故事:** 作为用户，我希望阻止发送中文文本，以确保我的所有消息在发送前都已翻译。

#### 验收标准

1. 当用户将"禁发中文"开关切换为开启时，翻译系统应阻止发送包含中文字符的消息
2. 当用户将"禁发中文"开关切换为关闭时，翻译系统应允许发送包含中文字符的消息
3. 当启用中文拦截时用户尝试发送包含中文的消息，翻译系统应显示警告提示
4. 当启用中文拦截时，翻译系统应在检测到输入框中有中文文本时禁用发送按钮

### 需求 4：高级翻译功能

**用户故事:** 作为用户，我希望使用高级翻译功能，以便实时预览翻译并验证翻译准确性。

#### 验收标准

1. 当用户将"实时翻译预览"开关切换为开启时，翻译系统应在用户输入时在输入框上方显示实时翻译预览
2. 当用户将"实时翻译预览"开关切换为关闭时，翻译系统应移除实时翻译预览
3. 当用户将"反向翻译验证"开关切换为开启时，翻译系统应在翻译输入框内容后显示反向翻译结果
4. 当用户将"反向翻译验证"开关切换为关闭时，翻译系统应跳过反向翻译验证
5. 当显示反向翻译时，翻译系统应显示原文与反向翻译文本之间的相似度百分比

### 需求 5：好友独立配置

**用户故事:** 作为用户，我希望为每个联系人配置翻译设置，以便为不同的对话自定义翻译行为。

#### 验收标准

1. 当用户将"好友独立配置"开关切换为开启时，翻译系统应启用按联系人配置选项
2. 当用户将"好友独立配置"开关切换为关闭时，翻译系统应对所有联系人使用全局配置
3. 当用户为某个联系人启用独立配置时，翻译系统应使用该联系人的特定目标语言和中文拦截设置
4. 当用户切换到启用了独立配置的不同聊天时，翻译系统应加载并应用该联系人的特定设置

### 需求 6：翻译引擎和语言设置

**用户故事:** 作为用户，我希望更改翻译引擎和语言设置，以便自定义消息的翻译方式。

#### 验收标准

1. 当用户更改"聊天窗口翻译引擎"选择时，翻译系统应使用所选引擎翻译收到的消息
2. 当用户更改"目标语言"选择时，翻译系统应将收到的消息翻译为所选语言
3. 当用户为某个引擎配置 API 设置时，翻译系统应使用这些 API 凭据进行该引擎的翻译
4. 当用户点击"测试连接"时，翻译系统应验证 API 配置是否正常工作

### 需求 7：配置更新方法

**用户故事:** 作为开发者，我希望 WhatsAppTranslation 对象具有 updateConfig 方法，以便可以通过编程方式应用配置更改。

#### 验收标准

1. 当调用 updateConfig 方法并传入新配置对象时，翻译系统应将新配置与现有配置进行深度合并
2. 当 updateConfig 方法成功更新配置时，翻译系统应立即将配置更改应用到所有模块
3. 当调用 updateConfig 方法时，翻译系统应通过 IPC 将更新后的配置保存到后端
4. 当 updateConfig 方法遇到错误时，翻译系统应返回包含描述性消息的错误响应
5. 当配置更改影响输入框翻译器时，翻译系统应重新初始化输入框翻译按钮和实时预览
6. 当配置更改影响中文拦截时，翻译系统应启用或禁用中文拦截处理器

### 需求 8：配置同步机制

**用户故事:** 作为开发者，我希望配置更改能够在设置面板和 BrowserView 之间同步，以便翻译系统保持同步。

#### 验收标准

1. 当从设置面板保存配置时，主进程应通过 IPC 通知相应的 BrowserView 配置已更改
2. 当 BrowserView 收到配置更改通知时，翻译系统应更新所有模块中的内部配置
3. 当调用 applyConfigToView 函数时，主进程应在 BrowserView 的上下文中执行 updateConfig 方法
4. 当收到 translation:configChanged 事件时，翻译系统应重新加载配置并应用更改

### 需求 9：翻译结果显示

**用户故事:** 作为用户，我希望翻译结果能够清晰显示，以便我能够轻松阅读翻译后的消息。

#### 验收标准

1. 当消息被翻译时，翻译系统应在原始消息下方显示翻译结果
2. 当翻译失败时，翻译系统应显示包含失败原因的错误消息
3. 当显示翻译时，翻译系统应显示源语言、目标语言和使用的引擎
4. 当使用缓存的翻译时，翻译系统应标识结果来自缓存

### 需求 10：聊天切换处理

**用户故事:** 作为用户，我希望翻译系统能够正确处理聊天切换，以便在切换对话时翻译功能正常工作。

#### 验收标准

1. 当用户切换到不同的聊天时，如果启用了自动翻译，翻译系统应翻译新聊天中的现有消息
2. 当用户切换到不同的聊天时，翻译系统应重新初始化输入框翻译按钮
3. 当用户切换到启用了独立配置的不同聊天时，翻译系统应应用该联系人的特定设置
4. 当用户切换到不同的聊天时，翻译系统应根据新联系人的设置重置中文拦截
